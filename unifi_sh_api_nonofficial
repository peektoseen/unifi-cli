###
### Added by xezpeleta
###

# list devices
unifi_list_dev() {
    api_log_info "Получение списка всех устройств"
    curl_with_log "$baseurl/api/s/$site/stat/device" --data "json={}"
}

# list ap devices
unifi_list_ap() {
    api_log_info "Получение списка точек доступа"
    curl_with_log "$baseurl/api/s/$site/stat/device" --data "json={'type':'uap'}"
}

# reboot a device
unifi_reboot_dev() {
    if [ $# -lt 1 ] ; then
        echo "Usage: $0 <mac>"
    fi

    mac=$1

    api_log_info "Отправка команды перезагрузки устройству: MAC=$mac"
    curl_with_log "$baseurl/api/s/$site/cmd/devmgr" --data "json={'cmd':'restart', 'mac':'${mac}'}"
    api_log_info "Команда перезагрузки отправлена"
}

# reboot all ap devices
unifi_reboot_all_ap() {
    # seconds to wait between AP reboots
    wait=180
    
    if [ $# -gt 1 ] ; then
        echo "Usage: $0"
    fi
    
    api_log_info "Начало постепенной перезагрузки всех точек доступа"
    api_log_info "Интервал между перезагрузками: $wait секунд"
    
    # Get all APs on the site
    curl_with_log "$baseurl/api/s/$site/stat/device" --data "json={'type':'uap'}" | jq -r '.data[] | .mac' | while read mac
    do
        #mac=${mac%\"}
        #mac=${mac#\"}
        api_log_info "Перезагрузка точки доступа: $mac"
        echo "Rebooting AP: $mac"
        unifi_reboot_dev $mac
        api_log_info "Ожидание $wait секунд перед следующей перезагрузкой"
        sleep $wait
    done
    
    api_log_info "Постепенная перезагрузка завершена"
}


# upgrade device
unifi_upgrade_dev() {
    if [ $# -lt 1 ] ; then
	echo "Usage: $0 <mac>"
	return
    fi
    
    mac=$1

    api_log_info "Отправка команды обновления устройству: MAC=$mac"
    curl_with_log "$baseurl/api/s/$site/cmd/devmgr/upgrade" --data "json={'mac':'${mac}'}"
    api_log_info "Команда обновления отправлена"
}

# upgrade all aps (rolling upgrade)
unifi_ap_rolling_upgrade() {
    api_log_info "Запуск постепенного обновления всех точек доступа (rolling upgrade)"
    curl_with_log "$baseurl/api/s/$site/cmd/devmgr/" --data "json={'cmd':'set-rollupgrade'}"
    api_log_info "Постепенное обновление запущено"
}

# abort rolling upgrade
unifi_ap_rolling_upgrade_cancel() {
    api_log_info "Отмена постепенного обновления"
    curl_with_log "$baseurl/api/s/$site/cmd/devmgr/" --data "json={'cmd':'unset-rollupgrade'}"
    api_log_info "Постепенное обновление отменено"
}
