# Логирование в UniFi CLI

## Обзор

Во все скрипты проекта добавлено подробное логирование для отслеживания выполнения операций и отладки проблем.

## Уровни логирования

### INFO
Основная информация о выполнении:
- Запуск и завершение скрипта
- Загрузка конфигурации и библиотек
- Выполняемые команды и операции
- Авторизация и выход

### DEBUG
Детальная отладочная информация (активируется флагом `-d`):
- Аргументы командной строки
- Пути к файлам и директориям
- Параметры функций
- JSON данные для API запросов
- URL запросов к API
- HTTP коды ответов
- Содержимое ответов (первые 200 символов)
- Параметры curl

### ERROR
Сообщения об ошибках с детальным описанием:
- Отсутствующие файлы конфигурации
- Ошибки подключения (HTTP 000)
- Ошибки авторизации (HTTP 401)
- Ошибки доступа (HTTP 403, 404)
- Ошибки сервера (HTTP 500, 502, 503)
- Неверные параметры
- Пустые ответы от сервера
- Рекомендации по устранению проблем

## Формат логов

Все логи выводятся в stderr в формате:
```
[ГГГГ-ММ-ДД ЧЧ:ММ:СС] [УРОВЕНЬ] Сообщение
```

Примеры:
```
[2025-10-16 19:04:55] [INFO] Запуск UniFi CLI версии 0.1.3_alpha
[2025-10-16 19:04:55] [DEBUG] Аргументы командной строки: -d -v
[2025-10-16 19:04:55] [ERROR] Конфигурационный файл не найден
```

## Префиксы логов по компонентам

- **Основной скрипт (unifi)**: Стандартные уровни (INFO, DEBUG, ERROR)
- **API библиотека**: `[API-INFO]`, `[API-DEBUG]`
- **Примерный скрипт**: `[SCRIPT-INFO]`, `[SCRIPT-DEBUG]`

## Использование

### Обычный режим
```bash
./unifi --list 2>&1
```
Выводит только информационные логи и логи ошибок.

### Режим отладки
```bash
./unifi -d --list 2>&1
```
Выводит все логи, включая отладочные.

### Перенаправление логов в файл
```bash
# Только логи (stderr)
./unifi --list 2> unifi.log

# Логи и вывод команды (stderr + stdout)
./unifi --list 2>&1 | tee unifi.log
```

## Примеры вывода

### Команда --list
```bash
$ ./unifi --list 2>&1
[2025-10-16 19:04:55] [INFO] Запуск UniFi CLI версии 0.1.3_alpha
[2025-10-16 19:04:55] [INFO] Загрузка конфигурационного файла: /path/to/unifi.conf
[2025-10-16 19:04:55] [INFO] Загрузка библиотеки API: unifi_sh_api
[2025-10-16 19:04:55] [INFO] Загрузка библиотеки API: unifi_sh_api_nonofficial
[2025-10-16 19:04:55] [INFO] Обработка команды: --list
[2025-10-16 19:04:55] [INFO] Выполнение команды: list
[2025-10-16 19:04:55] [INFO] Попытка авторизации в UniFi Controller
[2025-10-16 19:04:55] [API-INFO] Начало авторизации в UniFi Controller: https://unificontroller:8443
[2025-10-16 19:04:55] [API-INFO] Авторизация завершена
[2025-10-16 19:04:55] [INFO] Получение списка всех устройств
[2025-10-16 19:04:55] [API-INFO] Получение списка всех устройств
... JSON вывод устройств ...
[2025-10-16 19:04:56] [INFO] Выход из UniFi Controller
[2025-10-16 19:04:56] [API-INFO] Выход из UniFi Controller
[2025-10-16 19:04:56] [API-INFO] Выход завершен
[2025-10-16 19:04:56] [INFO] Команда list завершена успешно
[2025-10-16 19:04:56] [INFO] Скрипт UniFi CLI завершил работу
```

### Команда --reboot с отладкой
```bash
$ ./unifi -d --reboot 44:d9:e1:99:99:99 2>&1
[2025-10-16 19:05:00] [INFO] Запуск UniFi CLI версии 0.1.3_alpha
[2025-10-16 19:05:00] [DEBUG] Аргументы командной строки: -d --reboot 44:d9:e1:99:99:99
[2025-10-16 19:05:00] [DEBUG] Путь к скрипту: /path/to/unifi
[2025-10-16 19:05:00] [DEBUG] Директория скрипта: /path/to
[2025-10-16 19:05:00] [INFO] Загрузка конфигурационного файла: /path/to/unifi.conf
[2025-10-16 19:05:00] [INFO] Загрузка библиотеки API: unifi_sh_api
[2025-10-16 19:05:00] [INFO] Загрузка библиотеки API: unifi_sh_api_nonofficial
[2025-10-16 19:05:00] [INFO] Включен режим отладки (DEBUG)
[2025-10-16 19:05:00] [INFO] Обработка команды: --reboot
[2025-10-16 19:05:00] [INFO] Выполнение команды: reboot
[2025-10-16 19:05:00] [DEBUG] Параметры reboot: 44:d9:e1:99:99:99
[2025-10-16 19:05:00] [INFO] Попытка авторизации в UniFi Controller
[2025-10-16 19:05:00] [API-INFO] Начало авторизации в UniFi Controller: https://unificontroller:8443
[2025-10-16 19:05:00] [API-DEBUG] Пользователь: admin, Сайт: default
[2025-10-16 19:05:01] [API-INFO] Авторизация завершена
[2025-10-16 19:05:01] [INFO] Перезагрузка устройства с MAC: 44:d9:e1:99:99:99
[2025-10-16 19:05:01] [API-INFO] Отправка команды перезагрузки устройству: MAC=44:d9:e1:99:99:99
[2025-10-16 19:05:01] [API-INFO] Команда перезагрузки отправлена
[2025-10-16 19:05:01] [INFO] Выход из UniFi Controller
[2025-10-16 19:05:01] [API-INFO] Выход из UniFi Controller
[2025-10-16 19:05:01] [API-INFO] Выход завершен
[2025-10-16 19:05:01] [INFO] Команда reboot завершена успешно
[2025-10-16 19:05:01] [INFO] Скрипт UniFi CLI завершил работу
```

## Логируемые операции

### Основной скрипт (unifi)
- Запуск и инициализация
- Загрузка конфигурации и библиотек
- Обработка команд: show, list, reboot, upgrade
- Режимы: rolling, debug, help, version
- Авторизация и выход

### API библиотека (unifi_sh_api)
- Авторизация и выход из контроллера
- Вызовы API
- Авторизация гостей
- Резервное копирование
- Создание ваучеров
- Список подключенных станций
- Обновление устройств

### Неофициальное API (unifi_sh_api_nonofficial)
- Список устройств и точек доступа
- Перезагрузка устройств
- Постепенная перезагрузка всех AP
- Обновление устройств
- Постепенное обновление (rolling upgrade)

## Диагностика проблем

### Ошибка подключения (HTTP 000)
```
[API-ERROR] Ошибка подключения: сервер недоступен (HTTP 000)
[API-ERROR] Проверьте: 1) доступность сервера, 2) правильность URL в конфигурации, 3) сетевое подключение
```

**Причины:**
- UniFi Controller недоступен или выключен
- Неправильный URL в `unifi.conf` (например, `unificontroller` вместо реального IP/hostname)
- Блокировка сетевым firewall
- Неправильный порт (обычно 8443)

**Решение:**
1. Проверьте доступность: `ping unificontroller` или `telnet unificontroller 8443`
2. Проверьте URL в файле `unifi.conf`
3. Убедитесь, что UniFi Controller запущен

### Ошибка авторизации (HTTP 401)
```
[API-ERROR] Ошибка авторизации (HTTP 401): неверные учетные данные
```

**Причины:**
- Неправильный логин или пароль в `unifi.conf`
- Учетная запись заблокирована или удалена

**Решение:**
1. Проверьте `username` и `password` в файле `unifi.conf`
2. Попробуйте войти через веб-интерфейс с теми же учетными данными

### Пустой ответ (JSON ошибка)
```
Expecting value: line 1 column 1 (char 0)
[API-ERROR] Получен пустой ответ от сервера
```

**Причины:**
- Сервер не вернул JSON (обычно из-за ошибки подключения)
- Неправильный endpoint API
- Сессия истекла

**Решение:**
1. Проверьте логи DEBUG для HTTP кода
2. Убедитесь, что авторизация прошла успешно

## Советы по использованию

1. **Отладка проблем**: Используйте флаг `-d` для получения подробной информации
   ```bash
   ./unifi -d --list 2>&1 | less
   ```

2. **Мониторинг**: Перенаправляйте логи в файл для последующего анализа
   ```bash
   ./unifi --list 2> logs.txt
   # или с временной меткой
   ./unifi --list 2> "logs_$(date +%Y%m%d_%H%M%S).txt"
   ```

3. **Фильтрация**: Используйте `grep` для поиска конкретных событий:
   ```bash
   ./unifi --list 2>&1 | grep ERROR
   ./unifi -d --list 2>&1 | grep "HTTP код"
   ./unifi -d --reboot 44:d9:e1:99:99:99 2>&1 | grep API-DEBUG
   ```

4. **Временные метки**: Все логи содержат временные метки для точного отслеживания последовательности событий

5. **Анализ HTTP кодов**: В режиме DEBUG видны все HTTP коды, помогающие диагностировать проблемы:
   - 200 - успешно
   - 000 - ошибка подключения
   - 401 - неверная авторизация
   - 404 - endpoint не найден
   - 500+ - ошибка сервера

